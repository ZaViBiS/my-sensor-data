<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sensor Data Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #1a1a1a;
        color: #e0e0e0;
        padding: 20px;
      }
      #chartContainer {
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }
      canvas {
        width: 100% !important;
        height: auto !important;
        max-height: 400px;
      }
      #latestData {
        margin-top: 20px;
        padding: 15px;
        background-color: #2a2a2a;
        border-radius: 8px;
        text-align: center;
      }
      .label {
        font-weight: bold;
        color: #fff;
      }
      .temp { color: #FF6384; }
      .hum { color: #36A2EB; }
      .vpd { color: #FFCE56; }
      .fan { color: #4BC0C0; }
      .time { color: #e0e0e0; }
    </style>
  </head>
  <body>
    <h1 style="text-align:center;">Sensor Data Viewer</h1>
    <div id="chartContainer">
      <canvas id="sensorChart"></canvas>
    </div>
    <div id="latestData">
      <p><span class="label">Latest Temperature:</span> <span class="temp" id="latestTemp">--</span></p>
      <p><span class="label">Latest Humidity:</span> <span class="hum" id="latestHum">--</span></p>
      <p><span class="label">Latest VPD:</span> <span class="vpd" id="latestVpd">--</span></p>
      <p><span class="label">Latest Fan Speed:</span> <span class="fan" id="latestFan">--</span></p>
      <p><span class="label">Time Since Last Update:</span> <span class="time" id="timeSince">--</span></p>
    </div>

    <script>
      let latestTimestampSec = null;
      const ctx = document.getElementById("sensorChart").getContext("2d");
      const sensorChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Temperature (°C)",
              data: [],
              borderColor: "#FF6384",
              yAxisID: "y-temp",
              fill: false,
              pointRadius: 0,
            },
            {
              label: "Humidity (%)",
              data: [],
              borderColor: "#36A2EB",
              yAxisID: "y-hum",
              fill: false,
              pointRadius: 0,
            },
            {
              label: "VPD (kPa)",
              data: [],
              borderColor: "#FFCE56",
              yAxisID: "y-vpd",
              fill: false,
              pointRadius: 0,
            },
            {
              label: "Fan Speed",
              data: [],
              borderColor: "#4BC0C0",
              yAxisID: "y-fan",
              fill: false,
              pointRadius: 0,
            },
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: "index",
            intersect: false,
          },
          scales: {
            x: {
              ticks: { color: "#e0e0e0" },
              title: {
                display: true,
                text: "Time",
                color: "#e0e0e0"
              }
            },
            "y-temp": {
              type: "linear",
              position: "left",
              title: {
                display: true,
                text: "Temperature",
                color: "#FF6384"
              },
              ticks: { color: "#FF6384" }
            },
            "y-hum": {
              type: "linear",
              position: "right",
              title: {
                display: true,
                text: "Humidity",
                color: "#36A2EB"
              },
              ticks: { color: "#36A2EB" }
            },
            "y-vpd": {
              type: "linear",
              position: "left",
              title: {
                display: true,
                text: "VPD",
                color: "#FFCE56"
              },
              ticks: { color: "#FFCE56" }
            },
            "y-fan": {
              type: "linear",
              position: "right",
              title: {
                display: true,
                text: "Fan",
                color: "#4BC0C0"
              },
              ticks: { color: "#4BC0C0" }
            },
          },
          plugins: {
            legend: {
              labels: {
                color: "#e0e0e0"
              }
            }
          }
        }
      });

      function formatTimeElapsed(timestampSec) {
        const timestampMs = parseInt(timestampSec) * 1000;
        const now = Date.now();
        const diffSeconds = Math.floor((now - timestampMs) / 1000);
        if (diffSeconds < 0) return 'In the future';
        if (diffSeconds < 60) return `${diffSeconds} sec ago`;
        const minutes = Math.floor(diffSeconds / 60);
        if (minutes < 60) return `${minutes} min ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hr ago`;
        const days = Math.floor(hours / 24);
        return `${days} day${days === 1 ? '' : 's'} ago`;
      }

      async function fetchData() {
        try {
          const response = await fetch("https://data.ygryk.de", {
            method: "GET",
            headers: { "Content-Type": "application/json" }
          });

          const data = await response.json(); // <- should be array
          if (!Array.isArray(data)) throw new Error("Expected array of entries");

          const labels = [];
          const tempData = [];
          const humData = [];
          const vpdData = [];
          const fanData = [];

          data.sort((a, b) => a.time - b.time); // ensure chronological order
          const latest = data[data.length - 1];

          data.forEach(entry => {
            const date = new Date(entry.time * 1000);
            labels.push(date.toLocaleTimeString());
            tempData.push(entry.temp ?? null);
            humData.push(entry.hum ?? null);
            vpdData.push(entry.vpd ?? null);
            fanData.push(entry.fan_speed ?? null);
          });

          sensorChart.data.labels = labels;
          sensorChart.data.datasets[0].data = tempData;
          sensorChart.data.datasets[1].data = humData;
          sensorChart.data.datasets[2].data = vpdData;
          sensorChart.data.datasets[3].data = fanData;
          sensorChart.update();

          document.getElementById("latestTemp").textContent = latest.temp?.toFixed(1) + " °C" ?? "--";
          document.getElementById("latestHum").textContent = latest.hum?.toFixed(1) + " %" ?? "--";
          document.getElementById("latestVpd").textContent = latest.vpd?.toFixed(2) + " kPa" ?? "--";
          document.getElementById("latestFan").textContent = latest.fan_speed?.toFixed(0) ?? "--";
          latestTimestampSec = latest.time;
          document.getElementById("timeSince").textContent = formatTimeElapsed(latestTimestampSec);
        } catch (err) {
          console.error("Data error:", err);
        }
      }

      fetchData();
      setInterval(fetchData, 20000);
      setInterval(() => {
        if (latestTimestampSec !== null) {
          document.getElementById("timeSince").textContent = formatTimeElapsed(latestTimestampSec);
      }
}, 500);
    </script>
  </body>
</html>
