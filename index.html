<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sensor Data Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #1a1a1a;
        color: #e0e0e0;
        padding: 20px;
      }
      #chartContainer, .mobile-chart-container {
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        margin-bottom: 20px;
      }
      canvas {
        width: 100% !important;
        height: auto !important;
        max-height: 400px;
      }
      .mobile-chart-container canvas {
        max-height: 300px;
      }
      #latestData {
        margin-top: 20px;
        padding: 15px;
        background-color: #2a2a2a;
        border-radius: 8px;
        text-align: center;
      }
      .label {
        font-weight: bold;
        color: #fff;
      }
      .temp { color: #E57373; }
      .hum { color: #64B5F6; }
      .vpd { color: #FFD54F; }
      .fan { color: #4DB6AC; }
      .time { color: #B0BEC5; }
      .separator {
        border-top: 1px solid #B0BEC5;
        margin: 15px 0;
      }
      .toggle-container {
        text-align: center;
        margin-bottom: 20px;
      }
      .toggle-label {
        font-size: 16px;
        margin-right: 10px;
        vertical-align: middle;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
        vertical-align: middle;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #4DB6AC;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      .mobile-stats {
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-right: 20px;
        text-align: left;
        font-size: 14px;
      }
      .mobile-chart-wrapper {
        display: flex;
        align-items: center;
      }
      @media (max-width: 767px) {
        #chartContainer {
          display: none;
        }
        .mobile-charts {
          display: block;
        }
        canvas {
          max-height: 300px;
        }
      }
      @media (min-width: 768px) {
        .mobile-charts {
          display: none;
        }
        .mobile-stats {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <h1 style="text-align:center;">Sensor Data Viewer</h1>
    <div class="toggle-container">
      <label class="toggle-label" for="gapToggle">Show Gaps for Missing Data</label>
      <label class="toggle-switch">
        <input type="checkbox" id="gapToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div id="chartContainer">
      <canvas id="sensorChart"></canvas>
    </div>
    <div class="mobile-charts">
      <div class="mobile-chart-container">
        <h3 style="text-align:center; color:#E57373;">Temperatur</h3>
        <div class="mobile-chart-wrapper">
          <canvas id="tempChart"></canvas>
        </div>
      </div>
      <div class="mobile-chart-container">
        <h3 style="text-align:center; color:#64B5F6;">Feuchtigkeit</h3>
        <div class="mobile-chart-wrapper">
          <canvas id="humChart"></canvas>
        </div>
      </div>
      <div class="mobile-chart-container">
        <h3 style="text-align:center; color:#FFD54F;">VPD</h3>
        <div class="mobile-chart-wrapper">
          <canvas id="vpdChart"></canvas>
        </div>
      </div>
      <div class="mobile-chart-container">
        <h3 style="text-align:center; color:#4DB6AC;">Lüftergeschwindigkeit</h3>
        <div class="mobile-chart-wrapper">
          <canvas id="fanChart"></canvas>
        </div>
      </div>
    </div>
    <div id="latestData">
      <p><span class="label">Letzte Temperatur:</span> <span class="temp" id="latestTemp">--</span></p>
      <p><span class="label">Letzte Feuchtigkeit:</span> <span class="hum" id="latestHum">--</span></p>
      <p><span class="label">Letzter VPD:</span> <span class="vpd" id="latestVpd">--</span></p>
      <p><span class="label">Letzte Lüftergeschwindigkeit:</span> <span class="fan" id="latestFan">--</span></p>
      <p><span class="label">Zeit seit letztem Update:</span> <span class="time" id="timeSince">--</span></p>
    </div>

    <script>
      let latestTimestampSec = null;
      let showGaps = true;
      const isMobile = window.innerWidth < 768;
      let sensorChart, tempChart, humChart, vpdChart, fanChart;

      // Initialize charts based on device type
      if (!isMobile) {
        const ctx = document.getElementById("sensorChart").getContext("2d");
        sensorChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Temperatur (°C)",
                data: [],
                borderColor: "#E57373",
                yAxisID: "y-temp",
                fill: true,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Durchschn. Temperatur (24h)",
                data: [],
                borderColor: "#E57373",
                borderDash: [5, 5],
                yAxisID: "y-temp",
                fill: false,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Feuchtigkeit (%)",
                data: [],
                borderColor: "#64B5F6",
                yAxisID: "y-hum",
                fill: true,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Durchschn. Feuchtigkeit (24h)",
                data: [],
                borderColor: "#64B5F6",
                borderDash: [5, 5],
                yAxisID: "y-hum",
                fill: false,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "VPD (kPa)",
                data: [],
                borderColor: "#FFD54F",
                yAxisID: "y-vpd",
                fill: true,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Durchschn. VPD (24h)",
                data: [],
                borderColor: "#FFD54F",
                borderDash: [5, 5],
                yAxisID: "y-vpd",
                fill: false,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Lüftergeschwindigkeit",
                data: [],
                borderColor: "#4DB6AC",
                yAxisID: "y-fan",
                fill: true,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Durchschn. Lüftergeschwindigkeit (24h)",
                data: [],
                borderColor: "#4DB6AC",
                borderDash: [5, 5],
                yAxisID: "y-fan",
                fill: false,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
            ]
          },
          options: {
            responsive: true,
            layout: { padding: 0 },
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "day",
                  tooltipFormat: "dd.MM.yyyy",
                  displayFormats: {
                    day: "dd. MMM"
                  }
                },
                ticks: { color: "#e0e0e0" },
                title: {
                  display: true,
                  text: "Zeit",
                  color: "#e0e0e0"
                }
              },
              "y-temp": {
                type: "linear",
                position: "left",
                title: {
                  display: true,
                  text: "Temperatur",
                  color: "#E57373"
                },
                ticks: { color: "#E57373", maxTicksLimit: 4, padding: 2 }
              },
              "y-hum": {
                type: "linear",
                position: "right",
                title: {
                  display: true,
                  text: "Feuchtigkeit",
                  color: "#64B5F6"
                },
                ticks: { color: "#64B5F6", maxTicksLimit: 4, padding: 2 }
              },
              "y-vpd": {
                type: "linear",
                position: "left",
                title: {
                  display: true,
                  text: "VPD",
                  color: "#FFD54F"
                },
                ticks: { color: "#FFD54F", maxTicksLimit: 4, padding: 2 }
              },
              "y-fan": {
                type: "linear",
                position: "right",
                title: {
                  display: true,
                  text: "Lüfter",
                  color: "#4DB6AC"
                },
                ticks: { color: "#4DB6AC", maxTicksLimit: 4, padding: 2 }
              },
            },
            plugins: {
              legend: {
                labels: {
                  color: "#e0e0e0"
                }
              }
            }
          }
        });
      } else {
        // Initialize separate charts for mobile
        tempChart = new Chart(document.getElementById("tempChart").getContext("2d"), {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Temperatur (°C)",
                data: [],
                borderColor: "#E57373",
                backgroundColor: "rgba(229, 115, 115, 0.3)",
                fill: true,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Durchschn. Temperatur (24h)",
                data: [],
                borderColor: "#E57373",
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            layout: { padding: 0 },
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "day",
                  tooltipFormat: "dd.MM.yyyy",
                  displayFormats: {
                    day: "dd. MMM"
                  }
                },
                ticks: { color: "#e0e0e0" },
                title: {
                  display: true,
                  text: "Zeit",
                  color: "#e0e0e0"
                }
              },
              y: {
                title: {
                  display: true,
                  text: "Temperatur",
                  color: "#E57373"
                },
                ticks: {
                  color: "#E57373",
                  callback: function(value, index, values) {
                    if (index === 0) return "Min " + value.toFixed(1) + "°C";
                    if (index === Math.floor(values.length / 2)) return "AVG " + value.toFixed(1) + "°C";
                    if (index === values.length - 1) return "Max " + value.toFixed(1) + "°C";
                    return value.toFixed(1);
                  }
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y.toFixed(1) + '°C';
                    }
                    return label;
                  },
                  title: function(tooltipItems) {
                    const date = new Date(tooltipItems[0].parsed.x);
                    return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                  }
                }
              },
              annotation: {
                annotations: {
                  box1: {
                    type: 'box',
                    xMin: new Date('2025-03-06').getTime(),
                    xMax: new Date('2025-03-10').getTime(),
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    label: {
                      content: '06., 10. März',
                      enabled: true,
                      position: 'start'
                    }
                  }
                }
              }
            }
          }
        });

        humChart = new Chart(document.getElementById("humChart").getContext("2d"), {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Feuchtigkeit (%)",
                data: [],
                borderColor: "#64B5F6",
                backgroundColor: "rgba(100, 181, 246, 0.3)",
                fill: true,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Durchschn. Feuchtigkeit (24h)",
                data: [],
                borderColor: "#64B5F6",
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            layout: { padding: 0 },
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "day",
                  tooltipFormat: "dd.MM.yyyy",
                  displayFormats: {
                    day: "dd. MMM"
                  }
                },
                ticks: { color: "#e0e0e0" },
                title: {
                  display: true,
                  text: "Zeit",
                  color: "#e0e0e0"
                }
              },
              y: {
                title: {
                  display: true,
                  text: "Feuchtigkeit",
                  color: "#64B5F6"
                },
                ticks: {
                  color: "#64B5F6",
                  callback: function(value, index, values) {
                    if (index === 0) return "Min " + value.toFixed(1) + "%";
                    if (index === Math.floor(values.length / 2)) return "AVG " + value.toFixed(1) + "%";
                    if (index === values.length - 1) return "Max " + value.toFixed(1) + "%";
                    return value.toFixed(1);
                  }
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y.toFixed(1) + '%';
                    }
                    return label;
                  },
                  title: function(tooltipItems) {
                    const date = new Date(tooltipItems[0].parsed.x);
                    return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                  }
                }
              },
              annotation: {
                annotations: {
                  box1: {
                    type: 'box',
                    xMin: new Date('2025-03-06').getTime(),
                    xMax: new Date('2025-03-10').getTime(),
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    label: {
                      content: '06., 10. März',
                      enabled: true,
                      position: 'start'
                    }
                  }
                }
              }
            }
          }
        });

        vpdChart = new Chart(document.getElementById("vpdChart").getContext("2d"), {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "VPD (kPa)",
                data: [],
                borderColor: "#FFD54F",
                backgroundColor: "rgba(255, 213, 79, 0.3)",
                fill: true,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Durchschn. VPD (24h)",
                data: [],
                borderColor: "#FFD54F",
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            layout: { padding: 0 },
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "day",
                  tooltipFormat: "dd.MM.yyyy",
                  displayFormats: {
                    day: "dd. MMM"
                  }
                },
                ticks: { color: "#e0e0e0" },
                title: {
                  display: true,
                  text: "Zeit",
                  color: "#e0e0e0"
                }
              },
              y: {
                title: {
                  display: true,
                  text: "VPD",
                  color: "#FFD54F"
                },
                ticks: {
                  color: "#FFD54F",
                  callback: function(value, index, values) {
                    if (index === 0) return "Min " + value.toFixed(2) + " kPa";
                    if (index === Math.floor(values.length / 2)) return "AVG " + value.toFixed(2) + " kPa";
                    if (index === values.length - 1) return "Max " + value.toFixed(2) + " kPa";
                    return value.toFixed(2);
                  }
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y.toFixed(2) + ' kPa';
                    }
                    return label;
                  },
                  title: function(tooltipItems) {
                    const date = new Date(tooltipItems[0].parsed.x);
                    return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                  }
                }
              },
              annotation: {
                annotations: {
                  box1: {
                    type: 'box',
                    xMin: new Date('2025-03-06').getTime(),
                    xMax: new Date('2025-03-10').getTime(),
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    label: {
                      content: '06., 10. März',
                      enabled: true,
                      position: 'start'
                    }
                  }
                }
              }
            }
          }
        });

        fanChart = new Chart(document.getElementById("fanChart").getContext("2d"), {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Lüftergeschwindigkeit",
                data: [],
                borderColor: "#4DB6AC",
                backgroundColor: "rgba(77, 182, 172, 0.3)",
                fill: true,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              },
              {
                label: "Durchschn. Lüftergeschwindigkeit (24h)",
                data: [],
                borderColor: "#4DB6AC",
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                spanGaps: false,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            layout: { padding: 0 },
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "day",
                  tooltipFormat: "dd.MM.yyyy",
                  displayFormats: {
                    day: "dd. MMM"
                  }
                },
                ticks: { color: "#e0e0e0" },
                title: {
                  display: true,
                  text: "Zeit",
                  color: "#e0e0e0"
                }
              },
              y: {
                title: {
                  display: true,
                  text: "Lüfter",
                  color: "#4DB6AC"
                },
                ticks: {
                  color: "#4DB6AC",
                  callback: function(value, index, values) {
                    if (index === 0) return "Min " + value.toFixed(0);
                    if (index === Math.floor(values.length / 2)) return "AVG " + value.toFixed(0);
                    if (index === values.length - 1) return "Max " + value.toFixed(0);
                    return value.toFixed(0);
                  }
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y.toFixed(0);
                    }
                    return label;
                  },
                  title: function(tooltipItems) {
                    const date = new Date(tooltipItems[0].parsed.x);
                    return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                  }
                }
              },
              annotation: {
                annotations: {
                  box1: {
                    type: 'box',
                    xMin: new Date('2025-03-06').getTime(),
                    xMax: new Date('2025-03-10').getTime(),
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    label: {
                      content: '06., 10. März',
                      enabled: true,
                      position: 'start'
                    }
                  }
                }
              }
            }
          }
        });
      }

      function formatTimeElapsed(timestampSec) {
        const timestampMs = parseInt(timestampSec) * 1000;
        const now = Date.now();
        const diffSeconds = Math.floor((now - timestampMs) / 1000);
        if (diffSeconds < 0) return 'In der Zukunft';
        if (diffSeconds < 60) return `${diffSeconds} Sek. vor`;
        const minutes = Math.floor(diffSeconds / 60);
        if (minutes < 60) return `${minutes} Min. vor`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} Std. vor`;
        const days = Math.floor(hours / 24);
        return `${days} Tag${days === 1 ? '' : 'e'} vor`;
      }

      async function fetchData() {
        try {
          const response = await fetch("https://data.ygryk.de", {
            method: "GET",
            headers: { "Content-Type": "application/json" }
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("Expected non-empty array of entries");
          }

          const hasValidStructure = data.every(entry =>
            typeof entry === 'object' &&
            'time' in entry &&
            Number.isFinite(entry.time)
          );
          if (!hasValidStructure) {
            throw new Error("Invalid data structure: missing or invalid 'time' property");
          }

          data.sort((a, b) => a.time - b.time);
          const latest = data[data.length - 1] || {};

          // Reduce data points by averaging over 60-second intervals
          const intervalSec = 60;
          const reducedData = [];
          let currentBucket = null;

          data.forEach(entry => {
            const bucketTime = Math.floor(entry.time / intervalSec) * intervalSec;
            if (!currentBucket || currentBucket.time !== bucketTime) {
              if (currentBucket) reducedData.push(currentBucket);
              currentBucket = {
                time: bucketTime,
                temp: [],
                hum: [],
                vpd: [],
                fan_speed: []
              };
            }
            if (entry.temp != null) currentBucket.temp.push(entry.temp);
            if (entry.hum != null) currentBucket.hum.push(entry.hum);
            if (entry.vpd != null) currentBucket.vpd.push(entry.vpd);
            if (entry.fan_speed != null) currentBucket.fan_speed.push(entry.fan_speed);
          });
          if (currentBucket) reducedData.push(currentBucket);

          // Calculate averages for each bucket
          const averagedData = reducedData.map(bucket => ({
            time: bucket.time,
            temp: bucket.temp.length > 0 ? bucket.temp.reduce((sum, v) => sum + v, 0) / bucket.temp.length : null,
            hum: bucket.hum.length > 0 ? bucket.hum.reduce((sum, v) => sum + v, 0) / bucket.hum.length : null,
            vpd: bucket.vpd.length > 0 ? bucket.vpd.reduce((sum, v) => sum + v, 0) / bucket.vpd.length : null,
            fan_speed: bucket.fan_speed.length > 0 ? bucket.fan_speed.reduce((sum, v) => sum + v, 0) / bucket.fan_speed.length : null
          }));

          // Process data based on showGaps
          let processedData;
          if (showGaps) {
            processedData = [];
            const toleranceSec = 5;
            for (let i = 0; i < averagedData.length; i++) {
              processedData.push(averagedData[i]);
              if (i < averagedData.length - 1) {
                const currentTime = averagedData[i].time;
                const nextTime = averagedData[i + 1].time;
                const timeDiff = nextTime - currentTime;
                if (timeDiff > intervalSec + toleranceSec) {
                  const numMissing = Math.floor((timeDiff - intervalSec) / intervalSec);
                  for (let j = 1; j <= numMissing; j++) {
                    const missingTime = currentTime + j * intervalSec;
                    processedData.push({
                      time: missingTime,
                      temp: null,
                      hum: null,
                      vpd: null,
                      fan_speed: null
                    });
                  }
                }
              }
            }
            processedData.sort((a, b) => a.time - b.time);
          } else {
            processedData = averagedData.map((entry, index) => ({
              time: averagedData[0].time + index * intervalSec,
              temp: entry.temp,
              hum: entry.hum,
              vpd: entry.vpd,
              fan_speed: entry.fan_speed
            }));
          }

          // Filter data from the last 24 hours for averages
          const oneDaySec = 24 * 60 * 60;
          const latestTime = latest.time;
          const last24hData = processedData.filter(entry => entry.time >= latestTime - oneDaySec);

          // Calculate min/avg/max for last 24 hours
          let tempValues = last24hData.map(entry => entry.temp).filter(v => v != null && !isNaN(v));
          let humValues = last24hData.map(entry => entry.hum).filter(v => v != null && !isNaN(v));
          let vpdValues = last24hData.map(entry => entry.vpd).filter(v => v != null && !isNaN(v));
          let fanValues = last24hData.map(entry => entry.fan_speed).filter(v => v != null && !isNaN(v));

          const minTemp = tempValues.length > 0 ? Math.min(...tempValues) : null;
          const avgTemp = tempValues.length > 0 ? tempValues.reduce((sum, v) => sum + v, 0) / tempValues.length : null;
          const maxTemp = tempValues.length > 0 ? Math.max(...tempValues) : null;

          const minHum = humValues.length > 0 ? Math.min(...humValues) : null;
          const avgHum = humValues.length > 0 ? humValues.reduce((sum, v) => sum + v, 0) / humValues.length : null;
          const maxHum = humValues.length > 0 ? Math.max(...humValues) : null;

          const minVpd = vpdValues.length > 0 ? Math.min(...vpdValues) : null;
          const avgVpd = vpdValues.length > 0 ? vpdValues.reduce((sum, v) => sum + v, 0) / vpdValues.length : null;
          const maxVpd = vpdValues.length > 0 ? Math.max(...vpdValues) : null;

          const minFan = fanValues.length > 0 ? Math.min(...fanValues) : null;
          const avgFan = fanValues.length > 0 ? fanValues.reduce((sum, v) => sum + v, 0) / fanValues.length : null;
          const maxFan = fanValues.length > 0 ? Math.max(...fanValues) : null;

          // Prepare chart data
          const tempData = processedData.map(entry => ({ x: entry.time * 1000, y: entry.temp ?? null }));
          const humData = processedData.map(entry => ({ x: entry.time * 1000, y: entry.hum ?? null }));
          const vpdData = processedData.map(entry => ({ x: entry.time * 1000, y: entry.vpd ?? null }));
          const fanData = processedData.map(entry => ({ x: entry.time * 1000, y: entry.fan_speed ?? null }));

          const avgTempData = processedData.map(entry => ({ x: entry.time * 1000, y: avgTemp }));
          const avgHumData = processedData.map(entry => ({ x: entry.time * 1000, y: avgHum }));
          const avgVpdData = processedData.map(entry => ({ x: entry.time * 1000, y: avgVpd }));
          const avgFanData = processedData.map(entry => ({ x: entry.time * 1000, y: avgFan }));

          // Update Y-axis tick values for min/avg/max
          if (isMobile) {
            tempChart.options.scales.y.min = minTemp != null ? Math.floor(minTemp) : 0;
            tempChart.options.scales.y.max = maxTemp != null ? Math.ceil(maxTemp) : 100;
            tempChart.options.scales.y.ticks.stepSize = (maxTemp - minTemp) / (tempChart.options.scales.y.ticks.maxTicksLimit || 5);

            humChart.options.scales.y.min = minHum != null ? Math.floor(minHum) : 0;
            humChart.options.scales.y.max = maxHum != null ? Math.ceil(maxHum) : 100;
            humChart.options.scales.y.ticks.stepSize = (maxHum - minHum) / (humChart.options.scales.y.ticks.maxTicksLimit || 5);

            vpdChart.options.scales.y.min = minVpd != null ? Math.floor(minVpd * 10) / 10 : 0;
            vpdChart.options.scales.y.max = maxVpd != null ? Math.ceil(maxVpd * 10) / 10 : 5;
            vpdChart.options.scales.y.ticks.stepSize = (maxVpd - minVpd) / (vpdChart.options.scales.y.ticks.maxTicksLimit || 5);

            fanChart.options.scales.y.min = minFan != null ? Math.floor(minFan) : 0;
            fanChart.options.scales.y.max = maxFan != null ? Math.ceil(maxFan) : 100;
            fanChart.options.scales.y.ticks.stepSize = (maxFan - minFan) / (fanChart.options.scales.y.ticks.maxTicksLimit || 5);
          }

          // Update charts
          if (!isMobile) {
            sensorChart.data.datasets.forEach(dataset => {
              dataset.spanGaps = !showGaps;
            });
            sensorChart.data.datasets[0].data = tempData;
            sensorChart.data.datasets[1].data = avgTempData;
            sensorChart.data.datasets[2].data = humData;
            sensorChart.data.datasets[3].data = avgHumData;
            sensorChart.data.datasets[4].data = vpdData;
            sensorChart.data.datasets[5].data = avgVpdData;
            sensorChart.data.datasets[6].data = fanData;
            sensorChart.data.datasets[7].data = avgFanData;
            sensorChart.update();
          } else {
            tempChart.data.datasets[0].data = tempData;
            tempChart.data.datasets[1].data = avgTempData;
            tempChart.data.datasets.forEach(dataset => dataset.spanGaps = !showGaps);
            tempChart.update();

            humChart.data.datasets[0].data = humData;
            humChart.data.datasets[1].data = avgHumData;
            humChart.data.datasets.forEach(dataset => dataset.spanGaps = !showGaps);
            humChart.update();

            vpdChart.data.datasets[0].data = vpdData;
            vpdChart.data.datasets[1].data = avgVpdData;
            vpdChart.data.datasets.forEach(dataset => dataset.spanGaps = !showGaps);
            vpdChart.update();

            fanChart.data.datasets[0].data = fanData;
            fanChart.data.datasets[1].data = avgFanData;
            fanChart.data.datasets.forEach(dataset => dataset.spanGaps = !showGaps);
            fanChart.update();
          }

          // Update latest data
          document.getElementById("latestTemp").textContent = latest.temp != null ? latest.temp.toFixed(1) + " °C" : "--";
          document.getElementById("latestHum").textContent = latest.hum != null ? latest.hum.toFixed(1) + " %" : "--";
          document.getElementById("latestVpd").textContent = latest.vpd != null ? latest.vpd.toFixed(2) + " kPa" : "--";
          document.getElementById("latestFan").textContent = latest.fan_speed != null ? latest.fan_speed.toFixed(0) : "--";
          document.getElementById("timeSince").textContent = latestTimestampSec ? formatTimeElapsed(latestTimestampSec) : "--";

          latestTimestampSec = latest.time || null;
          const tableBody = document.querySelector("#dataTable tbody");
          tableBody.innerHTML = "";
          processedData.slice(-30).forEach(entry => {
            const date = new Date(entry.time * 1000);
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${date.toLocaleTimeString("de-DE", { hour: '2-digit', minute: '2-digit' })}</td>
              <td>${entry.temp != null ? entry.temp.toFixed(1) : "--"}</td>
              <td>${entry.hum != null ? entry.hum.toFixed(1) : "--"}</td>
              <td>${entry.vpd != null ? entry.vpd.toFixed(2) : "--"}</td>
              <td>${entry.fan_speed != null ? entry.fan_speed.toFixed(0) : "--"}</td>
            `;
            tableBody.appendChild(row);
          });

        } catch (err) {
          console.error("Fetch data error:", err.message);
          document.getElementById("latestTemp").textContent = "--";
          document.getElementById("latestHum").textContent = "--";
          document.getElementById("latestVpd").textContent = "--";
          document.getElementById("latestFan").textContent = "--";
          document.getElementById("timeSince").textContent = "--";
        }
      }

      // Toggle event listener
      document.getElementById("gapToggle").addEventListener("change", (event) => {
        showGaps = event.target.checked;
        fetchData();
      });

      fetchData();
      setInterval(fetchData, 60000); // Update every 60 seconds
      setInterval(() => {
        if (latestTimestampSec !== null) {
          document.getElementById("timeSince").textContent = formatTimeElapsed(latestTimestampSec);
        }
      }, 500);
    </script>
  
<div id="dataTableContainer" style="margin-top: 20px; background-color: #2a2a2a; padding: 10px; border-radius: 8px;">
  <h3 style="text-align: center;">Таблиця останніх значень</h3>
  <table id="dataTable" style="width: 100%; color: #e0e0e0; font-size: 14px;">
    <thead>
      <tr><th>Час</th><th>Температура (°C)</th><th>Вологість (%)</th><th>VPD (kPa)</th><th>Лю́фтер</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</body>
</html>
